<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFç·¨é›†ãƒ»å‡ºåŠ›ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆè¤‡æ•°ãƒšãƒ¼ã‚¸å¯¾å¿œç‰ˆï¼‰</title>
    
    <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿é †åºã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã—ã€ä¾å­˜é–¢ä¿‚ã‚’è€ƒæ…® -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        // jQueryãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
        if (typeof $ === 'undefined') {
            console.error('jQuery ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
            alert('ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script>
        // Fabric.jsãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
        if (typeof fabric === 'undefined') {
            console.error('Fabric.js ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
            alert('ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>
        // PDF.jsãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
        if (typeof pdfjsLib === 'undefined') {
            console.error('PDF.js ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
            alert('ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        } else {
            // ãƒ¯ãƒ¼ã‚«ãƒ¼ã®è¨­å®šã‚’ç¢ºå®Ÿã«è¡Œã†
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script>
        // PDF-LibãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
        if (typeof PDFLib === 'undefined') {
            console.error('PDF-Lib ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
            alert('ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        // FileSaverãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
        if (typeof saveAs === 'undefined') {
            console.error('FileSaver.js ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
            alert('ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        }
    </script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        .toolbar {
            width: 250px;
            background-color: #fff;
            border-right: 1px solid #ddd;
            padding: 15px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            overflow-y: auto;
            z-index: 10;
        }
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .canvas-area {
            flex: 1;
            overflow: auto;
            background-color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }
        .editor-wrapper {
            position: relative;
            background-color: white;
            border: 1px solid #ccc;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            margin: 0 auto;
            transition: transform 0.2s ease-in-out;
        }
        .pdf-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f8f8f8;
            color: #666;
            z-index: 1;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            writing-mode: horizontal-tb; /* æ¨ªæ›¸ãã‚’å¼·åˆ¶ */
        }
        .pdf-display {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 2;
        }
        #pdf-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }
        .canvas-container {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 3 !important;
        }
        .editor-controls {
            padding: 10px;
            background-color: #f0f0f0;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .tool-section {
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        .tool-section h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
            color: #555;
        }
        .tool-button {
            display: block;
            width: 100%;
            padding: 8px 12px;
            margin-bottom: 8px;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        .tool-button:hover {
            background-color: #e9f5ff;
            border-color: #2196F3;
        }
        .tool-button.active {
            background-color: #2196F3;
            color: white;
            border-color: #0b7dda;
        }
        .upload-container {
            padding: 15px;
            border: 2px dashed #ccc;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 15px;
            transition: all 0.2s;
        }
        .upload-container:hover {
            border-color: #2196F3;
            background-color: #f0f7ff;
        }
        .btn {
            padding: 6px 12px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
            margin-right: 5px;
        }
        .btn:hover {
            background-color: #0b7dda;
        }
        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
        }
        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .btn-secondary:disabled {
            background-color: #f0f0f0;
            color: #999;
        }
        .properties-panel {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f8f8;
            border-radius: 4px;
            display: none;
        }
        .properties-panel label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: #666;
        }
        .properties-panel input, .properties-panel select {
            width: 100%;
            padding: 6px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .field-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        .field-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .field-item:hover {
            background-color: #f0f7ff;
        }
        .field-delete {
            color: #d9534f;
            cursor: pointer;
            margin-left: 10px;
            font-size: 16px;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            color: #d9534f;
            background-color: #f2dede;
            border: 1px solid #ebccd1;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
            font-size: 14px;
        }
        /* æ‹¡å¤§ç¸®å°ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #zoom-level {
            min-width: 60px;
            text-align: center;
            user-select: none;
        }
        .zoom-btn {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }
        /* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆ */
        .upload-help {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
        }
        /* ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰é…ç½®ãƒ¢ãƒ¼ãƒ‰ */
        .placement-mode {
            cursor: cell !important;
        }
        .placement-mode-notice {
            background-color: #ffecb3;
            color: #856404;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 14px;
            text-align: center;
            display: none;
        }
        /* ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }
        /* åº§æ¨™è¡¨ç¤º */
        .coordinates-display {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 999;
            display: none;
        }
        /* ãƒšãƒ¼ã‚¸ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .page-navigation {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #page-display {
            min-width: 60px;
            text-align: center;
            user-select: none;
        }
        .page-btn {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }
        /* ãƒ‡ãƒ¼ã‚¿æ“ä½œãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— */
        .data-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        /* ã‚°ãƒªãƒƒãƒ‰ã‚¬ã‚¤ãƒ‰ */
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
            opacity: 0.5;
            display: none;
        }
        .grid-line-h, .grid-line-v {
            position: absolute;
            background-color: rgba(0, 128, 255, 0.3);
        }
        .grid-line-h {
            height: 1px;
            width: 100%;
        }
        .grid-line-v {
            width: 1px;
            height: 100%;
        }
        /* ä½ç½®æƒ…å ±è¡¨ç¤º */
        .position-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 999;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="toolbar">
            <div class="tool-section">
                <div class="upload-container">
                    <input type="file" id="pdf-upload" accept=".pdf" style="display: none;">
                    <button id="upload-btn" class="btn">PDFã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                    <p id="filename-display" class="upload-help"></p>
                </div>
                <div id="error-message" class="error-message"></div>
            </div>
            
            <div class="tool-section">
                <h3>ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ </h3>
                <div id="placement-mode-notice" class="placement-mode-notice">ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§è¦ç´ ã‚’é…ç½®</div>
                <button class="tool-button" data-tool="text">
                    <span>ğŸ“</span> ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›
                </button>
                <button class="tool-button" data-tool="checkbox">
                    <span>âœ“</span> ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯
                </button>
                <button class="tool-button" data-tool="x-mark">
                    <span>âœ—</span> ãƒãƒ„ãƒãƒ¼ã‚¯
                </button>
                <button class="tool-button" data-tool="dot">
                    <span>â€¢</span> ç‚¹
                </button>
                <button class="tool-button" data-tool="circle">
                    <span>â­˜</span> ä¸¸ã§å›²ã‚€
                </button>
                <button class="tool-button" data-tool="strikethrough">
                    <span>-</span> å–ã‚Šæ¶ˆã—ç·š
                </button>
            </div>
            
            <div class="tool-section">
                <h3>ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç®¡ç†</h3>
                <button id="delete-field-btn" class="btn btn-secondary">
                    é¸æŠã—ãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤
                </button>
                <button id="toggle-grid-btn" class="btn btn-secondary">
                    ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º
                </button>
                <div class="field-list" id="field-list">
                    <!-- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒªã‚¹ãƒˆãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                </div>
            </div>
            
            <div class="properties-panel" id="properties-panel">
                <h3>ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£</h3>
                <div id="text-properties">
                    <label>ãƒ†ã‚­ã‚¹ãƒˆ:</label>
                    <input type="text" id="field-text" />
                    
                    <label>ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º:</label>
                    <input type="number" id="field-font-size" min="8" max="72" value="14" />
                    
                    <label>ãƒ•ã‚©ãƒ³ãƒˆã‚¹ã‚¿ã‚¤ãƒ«:</label>
                    <select id="field-font-style">
                        <option value="normal">æ¨™æº–</option>
                        <option value="bold">å¤ªå­—</option>
                        <option value="italic">æ–œä½“</option>
                    </select>
                    
                    <div id="position-controls">
                        <label>Xåº§æ¨™:</label>
                        <input type="number" id="field-x" step="1" />
                        
                        <label>Yåº§æ¨™:</label>
                        <input type="number" id="field-y" step="1" />
                    </div>
                </div>
            </div>
        </div>
        
        <div class="editor-container">
            <div class="editor-controls">
                <div class="data-controls">
                    <button id="save-pdf-btn" class="btn" disabled>ç·¨é›†æ¸ˆã¿PDFã‚’ä¿å­˜</button>
                    <button id="save-data-btn" class="btn" disabled>ç·¨é›†ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜</button>
                    <button id="load-data-btn" class="btn" disabled>ç·¨é›†ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿</button>
                </div>
                <div class="page-navigation">
                    <button id="prev-page" class="btn btn-secondary page-btn" disabled>&lt;</button>
                    <span id="page-display">1 / 1</span>
                    <button id="next-page" class="btn btn-secondary page-btn" disabled>&gt;</button>
                </div>
                <div class="zoom-controls">
                    <button id="zoom-out" class="btn btn-secondary zoom-btn">-</button>
                    <span id="zoom-level">100%</span>
                    <button id="zoom-in" class="btn btn-secondary zoom-btn">+</button>
                </div>
            </div>
            
            <div class="canvas-area">
                <div id="upload-message" style="text-align: center; margin: 20px 0; display: block;">
                    <p>PDFã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>
                </div>
                <div class="editor-wrapper" style="display: none;">
                    <div class="pdf-display"></div>
                    <div class="grid-overlay" id="grid-overlay"></div>
                </div>
            </div>
            
            <div class="position-info" id="position-info" style="display: none;">åº§æ¨™: (0, 0)</div>
        </div>
    </div>
    
    <div id="tooltip" class="tooltip">ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§é…ç½®</div>
    
    <div class="loading-overlay" id="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
    </div>

    <script>
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
        const app = {
            pdfFile: null,
            pdfDoc: null,
            pdfPages: null,            // PDF.jsã®ãƒšãƒ¼ã‚¸ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
            fabricCanvas: null,
            fields: {},                // ãƒšãƒ¼ã‚¸ã”ã¨ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¿å­˜ã™ã‚‹è¾æ›¸ { pageNumber: [fields] }
            currentPage: 1,            // ç¾åœ¨è¡¨ç¤ºã—ã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ç•ªå·
            totalPages: 0,             // PDFã®ç·ãƒšãƒ¼ã‚¸æ•°
            selectedField: null,
            currentTool: null,
            pdfSize: { 
                width: 0, 
                height: 0, 
                rotation: 0,    // ãƒšãƒ¼ã‚¸ã®å›è»¢ï¼ˆåº¦æ•°ï¼‰
                offsetX: 0,     // Xè»¸ã‚ªãƒ•ã‚»ãƒƒãƒˆ
                offsetY: 0      // Yè»¸ã‚ªãƒ•ã‚»ãƒƒãƒˆ
            },
            pageSizes: {},             // ãƒšãƒ¼ã‚¸ã”ã¨ã®ã‚µã‚¤ã‚ºã‚’ä¿å­˜ã™ã‚‹è¾æ›¸ { pageNumber: {width, height, rotation, offsetX, offsetY} }
            zoomLevel: 1.0,
            minZoom: 0.5,
            maxZoom: 3.0,
            mousePosition: { x: 0, y: 0 },
            isLoading: false,         // èª­ã¿è¾¼ã¿ä¸­ãƒ•ãƒ©ã‚°ï¼ˆé‡è¤‡å‡¦ç†é˜²æ­¢ç”¨ï¼‰
            showGrid: false,          // ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºãƒ•ãƒ©ã‚°
            gridSize: 20,             // ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰
            coordinateSystem: {
                // PDFã®åº§æ¨™ç³»ã¯å·¦ä¸‹ãŒåŸç‚¹(0,0)ã€å³ä¸ŠãŒ(width,height)
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®åº§æ¨™ç³»ã¯å·¦ä¸ŠãŒåŸç‚¹(0,0)ã€å³ä¸‹ãŒ(width,height)
                canvasToPdf: function(x, y, pageNumber) {
                    // å¯¾è±¡ãƒšãƒ¼ã‚¸ã®ã‚µã‚¤ã‚ºæƒ…å ±ã‚’å–å¾—
                    const pageSize = app.pageSizes[pageNumber] || app.pdfSize;
                    
                    // ã‚ºãƒ¼ãƒ è£œæ­£
                    const realX = x / app.zoomLevel;
                    const realY = y / app.zoomLevel;
                    
                    // å›è»¢ã‚’è€ƒæ…®ã—ãŸåº§æ¨™å¤‰æ›
                    let pdfX = realX;
                    let pdfY = pageSize.height - realY; // Yè»¸ã®åè»¢
                    
                    // ãƒšãƒ¼ã‚¸ã®å›è»¢ã«å¿œã˜ãŸåº§æ¨™è£œæ­£
                    if (pageSize.rotation === 90) {
                        const tempX = pdfX;
                        pdfX = pdfY;
                        pdfY = pageSize.width - tempX;
                    } else if (pageSize.rotation === 180) {
                        pdfX = pageSize.width - pdfX;
                        pdfY = pageSize.height - pdfY;
                    } else if (pageSize.rotation === 270) {
                        const tempX = pdfX;
                        pdfX = pageSize.height - pdfY;
                        pdfY = tempX;
                    }
                    
                    // ã‚ªãƒ•ã‚»ãƒƒãƒˆè£œæ­£
                    pdfX += pageSize.offsetX;
                    pdfY += pageSize.offsetY;
                    
                    return { x: pdfX, y: pdfY };
                },
                
                pdfToCanvas: function(x, y, pageNumber) {
                    // å¯¾è±¡ãƒšãƒ¼ã‚¸ã®ã‚µã‚¤ã‚ºæƒ…å ±ã‚’å–å¾—
                    const pageSize = app.pageSizes[pageNumber] || app.pdfSize;
                    
                    // ã‚ªãƒ•ã‚»ãƒƒãƒˆè£œæ­£
                    let canvasX = x - pageSize.offsetX;
                    let canvasY = y - pageSize.offsetY;
                    
                    // å›è»¢ã‚’è€ƒæ…®ã—ãŸåº§æ¨™å¤‰æ›
                    if (pageSize.rotation === 90) {
                        const tempX = canvasX;
                        canvasX = pageSize.width - canvasY;
                        canvasY = tempX;
                    } else if (pageSize.rotation === 180) {
                        canvasX = pageSize.width - canvasX;
                        canvasY = pageSize.height - canvasY;
                    } else if (pageSize.rotation === 270) {
                        const tempX = canvasX;
                        canvasX = canvasY;
                        canvasY = pageSize.height - tempX;
                    }
                    
                    // Yè»¸ã®åè»¢ï¼ˆPDFã¯å·¦ä¸‹åŸç‚¹ã€ã‚­ãƒ£ãƒ³ãƒã‚¹ã¯å·¦ä¸ŠåŸç‚¹ï¼‰
                    canvasY = pageSize.height - canvasY;
                    
                    // ã‚ºãƒ¼ãƒ è£œæ­£
                    canvasX *= app.zoomLevel;
                    canvasY *= app.zoomLevel;
                    
                    return { x: canvasX, y: canvasY };
                }
            }
        };
        
        // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è¨­å®š
        if (typeof PDFLib !== 'undefined') {
            const { PDFDocument, rgb, StandardFonts } = PDFLib;
        }
        
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼
        window.addEventListener('error', function(e) {
            console.error('ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼:', e.error);
            showDetailedError('äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', e.error);
        });
        
        // ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºã®é•ã„ã‚’æ¤œå‡ºã™ã‚‹è¨ºæ–­æ©Ÿèƒ½
        function diagnosePdfPages() {
            console.log('=== PDFå„ãƒšãƒ¼ã‚¸ã®ã‚µã‚¤ã‚ºè¨ºæ–­ ===');
            
            const sizeReport = {};
            let hasDifferentSizes = false;
            let referenceWidth = null;
            let referenceHeight = null;
            
            for (const pageNum in app.pageSizes) {
                const size = app.pageSizes[pageNum];
                sizeReport[pageNum] = {
                    width: size.width,
                    height: size.height,
                    rotation: size.rotation || 0,
                    aspectRatio: (size.width / size.height).toFixed(4)
                };
                
                // æœ€åˆã®ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã¨ã™ã‚‹
                if (referenceWidth === null) {
                    referenceWidth = size.width;
                    referenceHeight = size.height;
                } 
                // ã‚µã‚¤ã‚ºã®é•ã„ã‚’ãƒã‚§ãƒƒã‚¯
                else if (Math.abs(referenceWidth - size.width) > 0.5 || 
                         Math.abs(referenceHeight - size.height) > 0.5) {
                    hasDifferentSizes = true;
                }
            }
            
            console.log('ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºæƒ…å ±:', sizeReport);
            console.log('ãƒšãƒ¼ã‚¸é–“ã§ã‚µã‚¤ã‚ºãŒç•°ãªã‚‹:', hasDifferentSizes);
            
            if (hasDifferentSizes) {
                console.warn('è­¦å‘Š: ãƒšãƒ¼ã‚¸ã”ã¨ã«ã‚µã‚¤ã‚ºãŒç•°ãªã‚‹ãŸã‚ã€ä½ç½®ãšã‚ŒãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™');
            }
            
            return sizeReport;
        }
        
        // è¨ºæ–­ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰ã®è¿½åŠ 
        window.diagnoseApp = function() {
            console.log('=== PDFç·¨é›†ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨ºæ–­ ===');
            console.log('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹:', app);
            console.log('ãƒšãƒ¼ã‚¸æ•°:', app.totalPages);
            console.log('ç¾åœ¨ã®ãƒšãƒ¼ã‚¸:', app.currentPage);
            console.log('ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰:', app.fields);
            console.log('ãƒ©ã‚¤ãƒ–ãƒ©ãƒªçŠ¶æ…‹:');
            console.log('- jQuery:', typeof $ !== 'undefined');
            console.log('- Fabric.js:', typeof fabric !== 'undefined');
            console.log('- PDF.js:', typeof pdfjsLib !== 'undefined');
            console.log('- PDF-Lib:', typeof PDFLib !== 'undefined');
            console.log('- FileSaver:', typeof saveAs !== 'undefined');
            
            // ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºè¨ºæ–­ã‚’è¿½åŠ 
            const pageSizeDiagnosis = diagnosePdfPages();
            console.log('ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºè¨ºæ–­çµæœ:', pageSizeDiagnosis);
            
            return 'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨ºæ–­ãŒå®Œäº†ã—ã¾ã—ãŸã€‚è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        };
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–...');
            console.log('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨ºæ–­ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ window.diagnoseApp() ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
            setupEventListeners();
        });
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        function setupEventListeners() {
            console.log('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šä¸­...');
            
            try {
                // PDFã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ - jQueryä¾å­˜æ€§ã‚’æ¸›ã‚‰ã™
                document.getElementById('upload-btn').addEventListener('click', function() {
                    document.getElementById('pdf-upload').click();
                });
                
                // PDFãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚
                document.getElementById('pdf-upload').addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        if (file.type === 'application/pdf') {
                            handlePdfUpload(file);
                        } else {
                            showError('PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                        }
                    }
                });
                
                // ãƒ„ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ - jQueryã‚’ä½¿ç”¨
                $('.tool-button').on('click', function() {
                    const tool = $(this).data('tool');
                    setActiveTool(tool);
                });
                
                // å‰Šé™¤ãƒœã‚¿ãƒ³
                $('#delete-field-btn').on('click', deleteSelectedField);
                
                // ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºåˆ‡æ›¿ãƒœã‚¿ãƒ³
                $('#toggle-grid-btn').on('click', toggleGrid);
                
                // PDFä¿å­˜ãƒœã‚¿ãƒ³
                $('#save-pdf-btn').on('click', savePdf);
                
                // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³
                $('#save-data-btn').on('click', saveEditData);
                $('#load-data-btn').on('click', loadEditData);
                
                // ãƒšãƒ¼ã‚¸ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
                $('#prev-page').on('click', goToPreviousPage);
                $('#next-page').on('click', goToNextPage);
                
                // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å¤‰æ›´
                $('#field-text').on('input', updateFieldText);
                $('#field-font-size').on('input', updateFieldFontSize);
                $('#field-font-style').on('change', updateFieldFontStyle);
                $('#field-x').on('change', updateFieldPosition);
                $('#field-y').on('change', updateFieldPosition);
                
                // ã‚ºãƒ¼ãƒ æ©Ÿèƒ½
                $('#zoom-in').on('click', zoomIn);
                $('#zoom-out').on('click', zoomOut);
                
                // ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã®ã‚ºãƒ¼ãƒ 
                $('.canvas-area').on('wheel', function(e) {
                    if (e.originalEvent.ctrlKey) {
                        e.preventDefault();
                        if (e.originalEvent.deltaY < 0) {
                            zoomIn();
                        } else {
                            zoomOut();
                        }
                    }
                });
                
                // ãƒã‚¦ã‚¹ç§»å‹•æ™‚ã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã¨åº§æ¨™è¡¨ç¤º
                $('.canvas-area').on('mousemove', function(e) {
                    // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®æ›´æ–°
                    if (app.currentTool) {
                        app.mousePosition.x = e.pageX;
                        app.mousePosition.y = e.pageY;
                        
                        $('#tooltip').css({
                            left: e.pageX + 15,
                            top: e.pageY + 15
                        }).show();
                    } else {
                        $('#tooltip').hide();
                    }
                    
                    // åº§æ¨™è¡¨ç¤ºã®æ›´æ–°
                    if (app.fabricCanvas) {
                        const pointer = app.fabricCanvas.getPointer(e);
                        const pdfCoords = app.coordinateSystem.canvasToPdf(
                            pointer.x,
                            pointer.y,
                            app.currentPage
                        );
                        
                        $('#position-info').text(
                            `ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™: (${Math.round(pointer.x)}, ${Math.round(pointer.y)}) ` +
                            `PDFåº§æ¨™: (${Math.round(pdfCoords.x)}, ${Math.round(pdfCoords.y)})`
                        ).show();
                    }
                });
                
                // ãƒã‚¦ã‚¹ãŒé›¢ã‚ŒãŸã‚‰ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã¨åº§æ¨™è¡¨ç¤ºã‚’éè¡¨ç¤º
                $('.canvas-area').on('mouseleave', function() {
                    $('#tooltip').hide();
                    $('#position-info').hide();
                });
                
                console.log('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');
            } catch (error) {
                console.error('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
                showDetailedError('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', error);
            }
        }
        
        // ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºåˆ‡æ›¿
        function toggleGrid() {
            app.showGrid = !app.showGrid;
            
            if (app.showGrid) {
                createGrid();
                $('#toggle-grid-btn').text('ã‚°ãƒªãƒƒãƒ‰éè¡¨ç¤º');
                $('#grid-overlay').show();
            } else {
                $('#toggle-grid-btn').text('ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º');
                $('#grid-overlay').hide();
            }
        }
        
        // ã‚°ãƒªãƒƒãƒ‰ä½œæˆ
        function createGrid() {
            const gridOverlay = $('#grid-overlay');
            gridOverlay.empty();
            
            if (!app.pdfSize.width || !app.pdfSize.height) return;
            
            const width = app.pdfSize.width * app.zoomLevel;
            const height = app.pdfSize.height * app.zoomLevel;
            const gridSize = app.gridSize * app.zoomLevel;
            
            // æ¨ªç·š
            for (let y = gridSize; y < height; y += gridSize) {
                const line = $('<div>').addClass('grid-line-h').css({
                    top: y + 'px'
                });
                gridOverlay.append(line);
            }
            
            // ç¸¦ç·š
            for (let x = gridSize; x < width; x += gridSize) {
                const line = $('<div>').addClass('grid-line-v').css({
                    left: x + 'px'
                });
                gridOverlay.append(line);
            }
        }
        
        // è©³ç´°ãªã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showDetailedError(message, error) {
            console.error(`ã‚¨ãƒ©ãƒ¼: ${message}`, error);
            
            // ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’å–å¾—
            let details = '';
            if (error && error.stack) {
                details = '<br><br><small>ãƒ‡ãƒãƒƒã‚°æƒ…å ±: ' + error.stack.split('\n')[0] + '</small>';
            }
            
            $('#error-message').html(`<strong>ã‚¨ãƒ©ãƒ¼:</strong> ${message}${details}`).show();
        }
        
        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            $('#error-message').html(`<strong>ã‚¨ãƒ©ãƒ¼:</strong> ${message}`).show();
            console.error('ã‚¨ãƒ©ãƒ¼: ' + message);
        }
        
        // ã‚¨ãƒ©ãƒ¼éè¡¨ç¤º
        function hideError() {
            $('#error-message').hide();
        }
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        function showLoading() {
            app.isLoading = true;
            $('#loading-overlay').show();
        }
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
        function hideLoading() {
            app.isLoading = false;
            $('#loading-overlay').hide();
        }
        
        // PDFå–ã‚Šè¾¼ã¿å‡¦ç†
        async function handlePdfUpload(file) {
            // é‡è¤‡å‡¦ç†é˜²æ­¢
            if (app.isLoading) return;
            
            showLoading();
            hideError();
            
            console.log('PDFãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ä¸­: ' + file.name);
            $('#filename-display').text(file.name);
            
            try {
                // PDFãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
                app.pdfFile = file;
                
                // PDF.jsã§PDFã‚’è§£æ
                const fileData = await readFileAsArrayBuffer(file);
                if (!fileData) {
                    throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                console.log('PDFãƒãƒƒãƒ•ã‚¡èª­ã¿è¾¼ã¿å®Œäº†: ' + fileData.byteLength + ' ãƒã‚¤ãƒˆ');
                
                // PDF.jsã§PDFã‚’è§£æ
                const loadingTask = pdfjsLib.getDocument({
                    data: fileData,
                    cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/cmaps/',
                    cMapPacked: true
                });
                
                // èª­ã¿è¾¼ã¿å¾…æ©Ÿ
                const pdf = await loadingTask.promise;
                
                console.log(`PDFã®èª­ã¿è¾¼ã¿å®Œäº†ã€‚ãƒšãƒ¼ã‚¸æ•°: ${pdf.numPages}`);
                app.pdfPages = pdf;
                app.totalPages = pdf.numPages;
                app.currentPage = 1;
                app.fields = {};  // ãƒšãƒ¼ã‚¸ã”ã¨ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’åˆæœŸåŒ–
                app.pageSizes = {};  // ãƒšãƒ¼ã‚¸ã”ã¨ã®ã‚µã‚¤ã‚ºã‚’åˆæœŸåŒ–
                
                // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤ºã«ã—ã€ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚’è¡¨ç¤º
                $('#upload-message').hide();
                $('.editor-wrapper').show();
                
                // æœ€åˆã®ãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿
                await loadPage(1);
                
                // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                $('#save-pdf-btn').prop('disabled', false);
                $('#save-data-btn').prop('disabled', false);
                $('#load-data-btn').prop('disabled', false);
                
                hideLoading();
                
            } catch (error) {
                console.error('PDFã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ', error);
                showDetailedError('PDFã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                hideLoading();
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿é–¢æ•°
        async function loadPage(pageNumber) {
            if (!app.pdfPages || pageNumber < 1 || pageNumber > app.totalPages) {
                return;
            }
            
            showLoading();
            console.log(`ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ä¸­: ${pageNumber}/${app.totalPages}`);
            
            try {
                // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¿å­˜ï¼ˆç¾åœ¨ã®ãƒšãƒ¼ã‚¸ãŒæœ‰åŠ¹ãªå ´åˆï¼‰
                if (app.fabricCanvas && app.currentPage >= 1 && app.currentPage <= app.totalPages) {
                    console.log(`ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ ${app.currentPage} ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¿å­˜`);
                    saveCurrentPageFields();
                }
                
                // ç¾åœ¨ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                if (app.fabricCanvas) {
                    console.log('æ—¢å­˜ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­...');
                    // é‡è¦: ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ã®ãŸã‚ã«ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’é©åˆ‡ã«ç ´æ£„
                    const oldCanvas = app.fabricCanvas;
                    app.fabricCanvas = null;
                    
                    try {
                        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‚ç…§ã‚’å‰Šé™¤
                        oldCanvas.dispose();
                    } catch (e) {
                        console.warn('ã‚­ãƒ£ãƒ³ãƒã‚¹ç ´æ£„ã‚¨ãƒ©ãƒ¼:', e);
                    }
                }
                
                // æ–°ã—ã„ãƒšãƒ¼ã‚¸ã‚’å–å¾—
                const page = await app.pdfPages.getPage(pageNumber);
                const viewport = page.getViewport({ scale: 1.0 });
                
                // PDFã®ã‚µã‚¤ã‚ºã‚’ä¿å­˜ - æ­£ç¢ºãªã‚µã‚¤ã‚ºã‚’è¨˜éŒ²
                app.pdfSize = {
                    width: viewport.width,
                    height: viewport.height,
                    rotation: viewport.rotation || 0, // å›è»¢æƒ…å ±ã‚‚è¨˜éŒ²
                    offsetX: viewport.offsetX || 0,   // ã‚ªãƒ•ã‚»ãƒƒãƒˆæƒ…å ±ã‚‚è¨˜éŒ²
                    offsetY: viewport.offsetY || 0
                };
                
                // ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºã‚’è¨˜éŒ²
                app.pageSizes[pageNumber] = {
                    width: viewport.width,
                    height: viewport.height,
                    rotation: viewport.rotation || 0,
                    offsetX: viewport.offsetX || 0,
                    offsetY: viewport.offsetY || 0
                };
                
                console.log(`ãƒšãƒ¼ã‚¸ ${pageNumber} ã‚µã‚¤ã‚º: ${viewport.width} x ${viewport.height}, å›è»¢: ${viewport.rotation}Â°`);
                
                // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°
                app.currentPage = pageNumber;
                
                // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
                setZoomLevel(1.0);
                
                // ã‚¨ãƒ‡ã‚£ã‚¿ã®ã‚µã‚¤ã‚ºã‚’åˆæœŸè¨­å®š
                updateEditorSize(true);
                
                // ä¸€æ™‚ã‚­ãƒ£ãƒ³ãƒã‚¹ã§PDFã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = viewport.width;
                tempCanvas.height = viewport.height;
                const tempContext = tempCanvas.getContext('2d');
                
                console.log('PDFã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­...');
                
                await page.render({
                    canvasContext: tempContext,
                    viewport: viewport
                }).promise;
                
                console.log('PDFã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Œäº†');
                
                // PDFè¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
                const pdfDisplay = $('.pdf-display');
                pdfDisplay.empty();
                
                // ç”»åƒã¨ã—ã¦è¡¨ç¤º
                const pdfImage = new Image();
                pdfImage.src = tempCanvas.toDataURL('image/png');
                pdfImage.id = 'pdf-image';
                
                // ç”»åƒã®ãƒ­ãƒ¼ãƒ‰å®Œäº†æ™‚
                pdfImage.onload = function() {
                    console.log('PDFç”»åƒã®ãƒ­ãƒ¼ãƒ‰å®Œäº†');
                    
                    // PDFè¡¨ç¤ºã‚’è¡¨ç¤º
                    pdfDisplay.empty().show().append(pdfImage);
                    
                    // Fabricã‚­ãƒ£ãƒ³ãƒã‚¹ã®åˆæœŸåŒ–
                    initFabricCanvas();
                    
                    // ã“ã®ãƒšãƒ¼ã‚¸ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Œã°å¾©å…ƒ
                    restorePageFields(pageNumber);
                    
                    // ã‚°ãƒªãƒƒãƒ‰ãŒæœ‰åŠ¹ãªã‚‰å†ä½œæˆ
                    if (app.showGrid) {
                        createGrid();
                        $('#grid-overlay').show();
                    }
                    
                    hideLoading();
                };
                
                // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼æ™‚
                pdfImage.onerror = function(e) {
                    console.error('PDFç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—', e);
                    showDetailedError('PDFã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ', new Error('ç”»åƒå¤‰æ›ã‚¨ãƒ©ãƒ¼'));
                    hideLoading();
                };
                
                // ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢
                tempCanvas.width = 0;
                tempCanvas.height = 0;
                
                // ãƒšãƒ¼ã‚¸è¡¨ç¤ºã‚’æ›´æ–°
                updatePageDisplay();
                
            } catch (error) {
                console.error(`ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ (è©³ç´°): `, error);
                showDetailedError(`ãƒšãƒ¼ã‚¸ ${pageNumber} ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ`, error);
                hideLoading();
            }
        }
        
        // å‰ã®ãƒšãƒ¼ã‚¸ã¸ç§»å‹•
        function goToPreviousPage() {
            if (app.currentPage > 1) {
                loadPage(app.currentPage - 1);
            }
        }
        
        // æ¬¡ã®ãƒšãƒ¼ã‚¸ã¸ç§»å‹•
        function goToNextPage() {
            if (app.currentPage < app.totalPages) {
                loadPage(app.currentPage + 1);
            }
        }
        
        // ãƒšãƒ¼ã‚¸è¡¨ç¤ºã‚’æ›´æ–°
        function updatePageDisplay() {
            $('#page-display').text(`${app.currentPage} / ${app.totalPages}`);
            
            // ãƒšãƒ¼ã‚¸ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã®è¨­å®š
            $('#prev-page').prop('disabled', app.currentPage <= 1);
            $('#next-page').prop('disabled', app.currentPage >= app.totalPages || app.totalPages <= 1);
        }
        
        // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¿å­˜
        function saveCurrentPageFields() {
            if (app.fabricCanvas) {
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
                const canvasObjects = app.fabricCanvas.getObjects();
                
                // æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒªã‚¹ãƒˆã‚’ä½œæˆ
                const updatedFields = [];
                
                for (const obj of canvasObjects) {
                    if (obj.id && obj.type) {
                        updatedFields.push({
                            id: obj.id,
                            type: obj.type,
                            object: obj
                        });
                    }
                }
                
                // æ›´æ–°ã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒªã‚¹ãƒˆã‚’ä¿å­˜
                app.fields[app.currentPage] = updatedFields;
                console.log(`ãƒšãƒ¼ã‚¸ ${app.currentPage} ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¿å­˜: ${updatedFields.length}ä»¶`);
            }
        }
        
        // æŒ‡å®šã•ã‚ŒãŸãƒšãƒ¼ã‚¸ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å¾©å…ƒ
        function restorePageFields(pageNumber) {
            if (!app.fabricCanvas) return;
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢
            app.fabricCanvas.clear();
            
            const pageFields = app.fields[pageNumber] || [];
            console.log(`ãƒšãƒ¼ã‚¸ ${pageNumber} ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å¾©å…ƒ: ${pageFields.length}ä»¶`);
            
            if (pageFields.length === 0) {
                // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                updateFieldList();
                return;
            }
            
            // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«è¿½åŠ 
            for (const field of pageFields) {
                let obj;
                
                // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãªã„å ´åˆï¼ˆJSONã‹ã‚‰èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ï¼‰
                if (!field.object && field.data) {
                    obj = field.data;
                } else {
                    obj = field.object;
                }
                
                // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                if (!obj) continue;
                
                // Fabric.jsã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¾©å…ƒ
                let fabricObj;
                
                try {
                    switch (field.type) {
                        case 'text':
                            fabricObj = new fabric.IText(obj.text || 'ãƒ†ã‚­ã‚¹ãƒˆ', {
                                left: obj.left,
                                top: obj.top,
                                fontSize: obj.fontSize || 14,
                                fill: obj.fill || '#000000',
                                fontFamily: obj.fontFamily || 'sans-serif',
                                fontWeight: obj.fontWeight || 'normal',
                                fontStyle: obj.fontStyle || 'normal',
                                id: field.id,
                                type: 'text'
                            });
                            break;
                            
                        case 'checkbox':
                        case 'x-mark':
                            const symbol = field.type === 'checkbox' ? 'âœ“' : 'âœ—';
                            fabricObj = new fabric.Text(symbol, {
                                left: obj.left,
                                top: obj.top,
                                fontSize: obj.fontSize || 20,
                                fill: obj.fill || '#000000',
                                fontFamily: obj.fontFamily || 'sans-serif',
                                id: field.id,
                                type: field.type
                            });
                            break;
                            
                        case 'dot':
                            fabricObj = new fabric.Circle({
                                left: obj.left,
                                top: obj.top,
                                radius: obj.radius || 5,
                                fill: obj.fill || '#000000',
                                id: field.id,
                                type: 'dot'
                            });
                            break;
                            
                        case 'circle':
                            fabricObj = new fabric.Circle({
                                left: obj.left,
                                top: obj.top,
                                radius: obj.radius || 15,
                                fill: obj.fill || 'transparent',
                                stroke: obj.stroke || '#000000',
                                strokeWidth: obj.strokeWidth || 2,
                                id: field.id,
                                type: 'circle'
                            });
                            break;
                            
                        case 'strikethrough':
                            fabricObj = new fabric.Line(
                                [obj.x1 || obj.left, 
                                 obj.y1 || obj.top, 
                                 obj.x2 || (obj.left + 50), 
                                 obj.y2 || obj.top], 
                                {
                                    stroke: obj.stroke || '#000000',
                                    strokeWidth: obj.strokeWidth || 2,
                                    id: field.id,
                                    type: 'strikethrough'
                                }
                            );
                            break;
                    }
                    
                    if (fabricObj) {
                        app.fabricCanvas.add(fabricObj);
                        field.object = fabricObj;  // å‚ç…§ã‚’æ›´æ–°
                        
                        // JSONãƒ‡ãƒ¼ã‚¿ã¯ä¸è¦ã«ãªã£ãŸã‚‰å‰Šé™¤
                        delete field.data;
                    }
                } catch (error) {
                    console.error(`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¾©å…ƒã‚¨ãƒ©ãƒ¼ (${field.id}, ${field.type}):`, error);
                }
            }
            
            // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒªã‚¹ãƒˆã‚’æ›´æ–°
            updateFieldList();
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’å†æç”»
            app.fabricCanvas.renderAll();
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ArrayBufferã¨ã—ã¦èª­ã¿è¾¼ã‚€
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = e => resolve(e.target.result);
                
                reader.onerror = e => {
                    console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
                    reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + (e.target.error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼')));
                };
                
                reader.readAsArrayBuffer(file);
            });
        }
        
        // ã‚ºãƒ¼ãƒ é–¢é€£ã®é–¢æ•°
        function setZoomLevel(level) {
            // æœ€å°ãƒ»æœ€å¤§ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã®åˆ¶é™
            level = Math.max(app.minZoom, Math.min(app.maxZoom, level));
            
            // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«æ›´æ–°
            app.zoomLevel = level;
            
            // è¡¨ç¤ºã‚’æ›´æ–°
            $('#zoom-level').text(Math.round(level * 100) + '%');
            
            // ã‚¨ãƒ‡ã‚£ã‚¿ã®ã‚µã‚¤ã‚ºã‚’æ›´æ–°
            updateEditorSize();
            
            // ã‚°ãƒªãƒƒãƒ‰ãŒæœ‰åŠ¹ãªã‚‰å†ä½œæˆ
            if (app.showGrid) {
                createGrid();
            }
        }
        
        function zoomIn() {
            setZoomLevel(app.zoomLevel + 0.1);
        }
        
        function zoomOut() {
            setZoomLevel(app.zoomLevel - 0.1);
        }
        
        function updateEditorSize(isInitial = false) {
            if (!app.pdfSize.width) return;
            
            // æ‹¡å¤§ç¸®å°å¾Œã®ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
            const zoomedWidth = app.pdfSize.width * app.zoomLevel;
            const zoomedHeight = app.pdfSize.height * app.zoomLevel;
            
            // ã‚¨ãƒ‡ã‚£ã‚¿ãƒ©ãƒƒãƒ‘ãƒ¼ã®ã‚µã‚¤ã‚ºã‚’æ›´æ–°
            $('.editor-wrapper').css({
                width: zoomedWidth + 'px',
                height: zoomedHeight + 'px'
            });
            
            // Fabricã‚­ãƒ£ãƒ³ãƒã‚¹ãŒã‚ã‚‹å ´åˆã¯æ›´æ–°
            if (app.fabricCanvas) {
                app.fabricCanvas.setWidth(zoomedWidth);
                app.fabricCanvas.setHeight(zoomedHeight);
                app.fabricCanvas.setZoom(app.zoomLevel);
                app.fabricCanvas.renderAll();
            }
        }
        
        // Fabricã‚­ãƒ£ãƒ³ãƒã‚¹ã®åˆæœŸåŒ–
        function initFabricCanvas() {
            console.log('Fabricã‚­ãƒ£ãƒ³ãƒã‚¹ã®åˆæœŸåŒ–ä¸­...');
            
            // PDFè¡¨ç¤ºã‚¨ãƒªã‚¢
            const pdfDisplay = $('.pdf-display');
            
            // æ—¢å­˜ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒã‚ã‚Œã°å‰Šé™¤
            if (app.fabricCanvas) {
                try {
                    app.fabricCanvas.dispose();
                } catch (e) {
                    console.warn('ã‚­ãƒ£ãƒ³ãƒã‚¹ç ´æ£„ã‚¨ãƒ©ãƒ¼:', e);
                }
            }
            
            // æ–°ã—ã„ã‚­ãƒ£ãƒ³ãƒã‚¹è¦ç´ ã‚’ä½œæˆ
            const canvasElement = $('<canvas>').attr('id', 'editor-canvas');
            pdfDisplay.append(canvasElement);
            
            // ã‚ºãƒ¼ãƒ é©ç”¨å¾Œã®ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
            const zoomedWidth = app.pdfSize.width * app.zoomLevel;
            const zoomedHeight = app.pdfSize.height * app.zoomLevel;
            
            try {
                // Fabricã‚­ãƒ£ãƒ³ãƒã‚¹ã®åˆæœŸåŒ–
                app.fabricCanvas = new fabric.Canvas('editor-canvas', {
                    width: zoomedWidth,
                    height: zoomedHeight,
                    selection: true,  // è¤‡æ•°é¸æŠã‚’æœ‰åŠ¹åŒ–
                    preserveObjectStacking: true  // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é‡ãªã‚Šé †ã‚’ä¿æŒ
                });
                
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’è¨­å®š
                app.fabricCanvas.setWidth(zoomedWidth);
                app.fabricCanvas.setHeight(zoomedHeight);
                app.fabricCanvas.setZoom(app.zoomLevel);
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠã‚’è¨­å®š
                app.fabricCanvas.on({
                    'object:selected': onObjectSelected,
                    'selection:cleared': onSelectionCleared,
                    'mouse:dblclick': onCanvasDoubleClick,
                    'mouse:move': onCanvasMouseMove
                });
                
                console.log('Fabricã‚­ãƒ£ãƒ³ãƒã‚¹ã®åˆæœŸåŒ–å®Œäº†');
                
                // åˆæœŸåŒ–ç›´å¾Œã«ä¸€åº¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                app.fabricCanvas.renderAll();
            } catch (error) {
                console.error('Fabricã‚­ãƒ£ãƒ³ãƒã‚¹åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showDetailedError('ç·¨é›†ã‚­ãƒ£ãƒ³ãƒã‚¹ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
            }
        }
        
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ„ãƒ¼ãƒ«ã®è¨­å®š
        function setActiveTool(tool) {
            // åŒã˜ãƒ„ãƒ¼ãƒ«ãŒå†åº¦ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯ãƒ„ãƒ¼ãƒ«ã‚’ã‚¯ãƒªã‚¢
            if (app.currentTool === tool) {
                // ç¾åœ¨ã®ãƒ„ãƒ¼ãƒ«ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
                $('.tool-button').removeClass('active');
                app.currentTool = null;
                $('.canvas-area').removeClass('placement-mode');
                $('#placement-mode-notice').hide();
                $('#tooltip').hide();
                
                if (app.fabricCanvas) {
                    app.fabricCanvas.defaultCursor = 'default';
                }
                return;
            }
            
            console.log('ãƒ„ãƒ¼ãƒ«é¸æŠ: ' + tool);
            
            // ç¾åœ¨ã®ãƒ„ãƒ¼ãƒ«ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            $('.tool-button').removeClass('active');
            
            // æ–°ã—ã„ãƒ„ãƒ¼ãƒ«ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            $(`.tool-button[data-tool="${tool}"]`).addClass('active');
            
            app.currentTool = tool;
            
            // é…ç½®ãƒ¢ãƒ¼ãƒ‰é€šçŸ¥ã®è¡¨ç¤º
            $('#placement-mode-notice').show();
            
            // ãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ«è¨­å®š
            if (app.fabricCanvas) {
                app.fabricCanvas.defaultCursor = 'cell';
                $('.canvas-area').addClass('placement-mode');
            }
        }
        
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒã‚¦ã‚¹ç§»å‹•æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
        function onCanvasMouseMove(options) {
            if (app.currentTool) {
                const pointer = app.fabricCanvas.getPointer(options.e);
                app.mousePosition = { x: options.e.pageX, y: options.e.pageY };
            }
        }
        
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
        function onCanvasDoubleClick(options) {
            if (app.currentTool && options.e && !options.target) {
                // ãƒã‚¤ãƒ³ã‚¿ä½ç½®ã‚’æ­£ç¢ºã«å–å¾—
                const pointer = app.fabricCanvas.getPointer(options.e, true); // ç²¾å¯†ãªåº§æ¨™ã‚’å–å¾—
                
                console.log(`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ ä½ç½® (ã‚­ãƒ£ãƒ³ãƒã‚¹ç²¾å¯†åº§æ¨™): (${pointer.x}, ${pointer.y})`);
                
                // ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã‚’PDFåº§æ¨™ã«å¤‰æ›ï¼ˆç¾åœ¨ã®ãƒšãƒ¼ã‚¸ç•ªå·ã‚’æŒ‡å®šï¼‰
                const pdfCoords = app.coordinateSystem.canvasToPdf(
                    pointer.x,
                    pointer.y,
                    app.currentPage
                );
                
                console.log(`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ ä½ç½® (PDFåº§æ¨™): (${pdfCoords.x}, ${pdfCoords.y})`);
                
                addField(pointer);
            }
        }
        
        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
        function addField(pointer) {
            if (!app.currentTool || !app.fabricCanvas) return;
            
            // ä¸€æ„ã®IDã‚’ç”Ÿæˆ
            const fieldId = `field-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
            
            let field;
            
            try {
                switch (app.currentTool) {
                    case 'text':
                        field = new fabric.IText('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›', {
                            left: pointer.x,
                            top: pointer.y,
                            fontSize: 14,
                            fill: '#000000',
                            fontFamily: 'sans-serif',
                            id: fieldId,
                            type: 'text'
                        });
                        break;
                        
                    case 'checkbox':
                        field = new fabric.Text('âœ“', {
                            left: pointer.x,
                            top: pointer.y,
                            fontSize: 20,
                            fill: '#000000',
                            fontFamily: 'sans-serif',
                            id: fieldId,
                            type: 'checkbox'
                        });
                        break;
                        
                    case 'x-mark':
                        field = new fabric.Text('âœ—', {
                            left: pointer.x,
                            top: pointer.y,
                            fontSize: 20,
                            fill: '#000000',
                            fontFamily: 'sans-serif',
                            id: fieldId,
                            type: 'x-mark'
                        });
                        break;
                        
                    case 'dot':
                        field = new fabric.Circle({
                            left: pointer.x - 5,
                            top: pointer.y - 5,
                            radius: 5,
                            fill: '#000000',
                            id: fieldId,
                            type: 'dot'
                        });
                        break;
                        
                    case 'circle':
                        field = new fabric.Circle({
                            left: pointer.x - 15,
                            top: pointer.y - 15,
                            radius: 15,
                            fill: 'transparent',
                            stroke: '#000000',
                            strokeWidth: 2,
                            id: fieldId,
                            type: 'circle'
                        });
                        break;
                        
                    case 'strikethrough':
                        field = new fabric.Line([pointer.x, pointer.y, pointer.x + 50, pointer.y], {
                            stroke: '#000000',
                            strokeWidth: 2,
                            id: fieldId,
                            type: 'strikethrough'
                        });
                        break;
                }
                
                if (field) {
                    app.fabricCanvas.add(field);
                    
                    // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰é…åˆ—ã‚’åˆæœŸåŒ–ï¼ˆå¿…è¦ãªå ´åˆï¼‰
                    if (!app.fields[app.currentPage]) {
                        app.fields[app.currentPage] = [];
                    }
                    
                    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å‚ç…§ã‚’ä¿æŒ
                    const fieldRef = {
                        id: fieldId,
                        type: app.currentTool,
                        object: field
                    };
                    
                    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
                    app.fields[app.currentPage].push(fieldRef);
                    
                    console.log(`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ : ${fieldId} (${app.currentTool}) - ãƒšãƒ¼ã‚¸ ${app.currentPage}`);
                    
                    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’é¸æŠçŠ¶æ…‹ã«
                    app.fabricCanvas.setActiveObject(field);
                    app.fabricCanvas.renderAll();
                    
                    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒªã‚¹ãƒˆæ›´æ–°
                    updateFieldList();
                    
                    return fieldRef; // å‚ç…§ã‚’è¿”ã™
                }
            } catch (error) {
                console.error('ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                showDetailedError('ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
            }
            
            return null;
        }
        
        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé¸æŠæ™‚
        function onObjectSelected(e) {
            try {
                const selectedObject = e.target;
                
                if (!selectedObject || !selectedObject.id) {
                    console.warn('é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«IDãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰æ¤œç´¢
                const pageFields = app.fields[app.currentPage] || [];
                app.selectedField = pageFields.find(f => f.id === selectedObject.id);
                
                if (app.selectedField) {
                    console.log(`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰é¸æŠ: ${app.selectedField.id} (${app.selectedField.type})`);
                    showPropertiesPanel(app.selectedField);
                    
                    // é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½ç½®ã‚’ãƒ­ã‚°
                    const obj = app.selectedField.object;
                    console.log(`é¸æŠãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä½ç½® (ã‚­ãƒ£ãƒ³ãƒã‚¹): (${obj.left}, ${obj.top})`);
                    
                    // PDFåº§æ¨™ã«å¤‰æ›
                    if (app.pdfSize && app.pdfSize.height) {
                        const pdfCoords = app.coordinateSystem.canvasToPdf(
                            obj.left,
                            obj.top,
                            app.currentPage
                        );
                        console.log(`é¸æŠãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä½ç½® (PDF): (${pdfCoords.x}, ${pdfCoords.y})`);
                    }
                }
            } catch (error) {
                console.error('ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé¸æŠã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // é¸æŠè§£é™¤æ™‚
        function onSelectionCleared() {
            app.selectedField = null;
            hidePropertiesPanel();
        }
        
        // é¸æŠã—ãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å‰Šé™¤
        function deleteSelectedField() {
            if (app.selectedField && app.fabricCanvas) {
                console.log(`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‰Šé™¤: ${app.selectedField.id}`);
                
                try {
                    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‹ã‚‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤
                    app.fabricCanvas.remove(app.selectedField.object);
                    
                    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ (ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã®ã¿)
                    if (app.fields[app.currentPage]) {
                        app.fields[app.currentPage] = app.fields[app.currentPage].filter(
                            f => f.id !== app.selectedField.id
                        );
                    }
                    
                    // é¸æŠçŠ¶æ…‹ã¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ‘ãƒãƒ«ã‚’ã‚¯ãƒªã‚¢
                    app.selectedField = null;
                    hidePropertiesPanel();
                    
                    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒªã‚¹ãƒˆæ›´æ–°
                    updateFieldList();
                } catch (error) {
                    console.error('ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    showDetailedError('ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                }
            }
        }
        
        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ç›´æ¥å‰Šé™¤
        function deleteField(fieldId) {
            // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰æ¤œç´¢
            const pageFields = app.fields[app.currentPage] || [];
            const fieldToDelete = pageFields.find(f => f.id === fieldId);
            
            if (fieldToDelete && app.fabricCanvas) {
                console.log(`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‰Šé™¤: ${fieldId}`);
                
                try {
                    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‹ã‚‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤
                    app.fabricCanvas.remove(fieldToDelete.object);
                    
                    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ (ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã®ã¿)
                    app.fields[app.currentPage] = pageFields.filter(f => f.id !== fieldId);
                    
                    // é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå‰Šé™¤å¯¾è±¡ã ã£ãŸå ´åˆ
                    if (app.selectedField && app.selectedField.id === fieldId) {
                        app.selectedField = null;
                        hidePropertiesPanel();
                    }
                    
                    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒªã‚¹ãƒˆæ›´æ–°
                    updateFieldList();
                    
                    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’å†æç”»
                    app.fabricCanvas.renderAll();
                } catch (error) {
                    console.error('ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    showDetailedError('ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                }
            }
        }
        
        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒªã‚¹ãƒˆã®æ›´æ–°
        function updateFieldList() {
            try {
                const fieldList = $('#field-list');
                fieldList.empty();
                
                // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å–å¾—
                const pageFields = app.fields[app.currentPage] || [];
                
                pageFields.forEach(field => {
                    const fieldType = field.type.charAt(0).toUpperCase() + field.type.slice(1);
                    const fieldItem = $(`
                        <div class="field-item" data-id="${field.id}">
                            <span>${fieldType}</span>
                            <span class="field-delete" data-id="${field.id}">Ã—</span>
                        </div>
                    `);
                    
                    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰é¸æŠ
                    fieldItem.on('click', function(e) {
                        if (!$(e.target).hasClass('field-delete')) {
                            const fieldId = $(this).data('id');
                            const fieldObj = pageFields.find(f => f.id === fieldId);
                            
                            if (fieldObj && fieldObj.object && app.fabricCanvas) {
                                app.fabricCanvas.setActiveObject(fieldObj.object);
                                app.fabricCanvas.renderAll();
                            }
                        }
                    });
                    
                    // å€‹åˆ¥ã®å‰Šé™¤ãƒœã‚¿ãƒ³
                    fieldItem.find('.field-delete').on('click', function(e) {
                        e.stopPropagation();
                        const fieldId = $(this).data('id');
                        deleteField(fieldId);
                    });
                    
                    fieldList.append(fieldItem);
                });
                
                console.log(`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒªã‚¹ãƒˆæ›´æ–°: ${pageFields.length}ä»¶ (ãƒšãƒ¼ã‚¸ ${app.currentPage})`);
            } catch (error) {
                console.error('ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒªã‚¹ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ‘ãƒãƒ«è¡¨ç¤º
        function showPropertiesPanel(field) {
            try {
                const panel = $('#properties-panel');
                panel.show();
                
                const obj = field.object;
                
                // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡¨ç¤º
                if (field.type === 'text') {
                    $('#text-properties').show();
                    $('#field-text').val(obj.text);
                    $('#field-font-size').val(obj.fontSize);
                    
                    let fontStyle = 'normal';
                    if (obj.fontWeight === 'bold') {
                        fontStyle = 'bold';
                    } else if (obj.fontStyle === 'italic') {
                        fontStyle = 'italic';
                    }
                    $('#field-font-style').val(fontStyle);
                } else {
                    $('#text-properties').hide();
                }
                
                // ä½ç½®æƒ…å ±ã‚’è¡¨ç¤º
                $('#field-x').val(Math.round(obj.left));
                $('#field-y').val(Math.round(obj.top));
                $('#position-controls').show();
            } catch (error) {
                console.error('ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ‘ãƒãƒ«è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ‘ãƒãƒ«éè¡¨ç¤º
        function hidePropertiesPanel() {
            $('#properties-panel').hide();
        }
        
        // ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
        function updateFieldText() {
            if (app.selectedField && app.selectedField.type === 'text' && app.fabricCanvas) {
                try {
                    const newText = $('#field-text').val();
                    app.selectedField.object.set('text', newText);
                    app.fabricCanvas.renderAll();
                } catch (error) {
                    console.error('ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
        }
        
        // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºæ›´æ–°
        function updateFieldFontSize() {
            if (app.selectedField && (app.selectedField.type === 'text' || 
                app.selectedField.type === 'checkbox' || 
                app.selectedField.type === 'x-mark') && app.fabricCanvas) {
                try {
                    const fontSize = parseInt($('#field-font-size').val(), 10);
                    if (isNaN(fontSize) || fontSize < 8 || fontSize > 72) return;
                    
                    app.selectedField.object.set('fontSize', fontSize);
                    app.fabricCanvas.renderAll();
                } catch (error) {
                    console.error('ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
        }
        
        // ãƒ•ã‚©ãƒ³ãƒˆã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
        function updateFieldFontStyle() {
            if (app.selectedField && (app.selectedField.type === 'text' || 
                app.selectedField.type === 'checkbox' || 
                app.selectedField.type === 'x-mark') && app.fabricCanvas) {
                try {
                    const fontStyle = $('#field-font-style').val();
                    
                    // ãƒªã‚»ãƒƒãƒˆ
                    app.selectedField.object.set({
                        fontWeight: 'normal',
                        fontStyle: 'normal'
                    });
                    
                    // é¸æŠã•ã‚ŒãŸã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
                    if (fontStyle === 'bold') {
                        app.selectedField.object.set('fontWeight', 'bold');
                    } else if (fontStyle === 'italic') {
                        app.selectedField.object.set('fontStyle', 'italic');
                    }
                    
                    app.fabricCanvas.renderAll();
                } catch (error) {
                    console.error('ãƒ•ã‚©ãƒ³ãƒˆã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
        }
        
        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä½ç½®æ›´æ–°
        function updateFieldPosition() {
            if (app.selectedField && app.fabricCanvas) {
                try {
                    const x = parseInt($('#field-x').val(), 10);
                    const y = parseInt($('#field-y').val(), 10);
                    
                    if (!isNaN(x)) {
                        app.selectedField.object.set('left', x);
                    }
                    
                    if (!isNaN(y)) {
                        app.selectedField.object.set('top', y);
                    }
                    
                    app.fabricCanvas.renderAll();
                    
                    // PDFåº§æ¨™ã‚‚è¨ˆç®—ã—ã¦è¡¨ç¤º
                    const pdfCoords = app.coordinateSystem.canvasToPdf(
                        x,
                        y,
                        app.currentPage
                    );
                    console.log(`æ›´æ–°å¾Œã®PDFåº§æ¨™: (${pdfCoords.x}, ${pdfCoords.y})`);
                } catch (error) {
                    console.error('ä½ç½®æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
        }
        
        // PDFä¿å­˜å‡¦ç†
        async function savePdf() {
            if (!app.pdfFile) {
                showError('PDFãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }
            
            // é‡è¤‡å‡¦ç†é˜²æ­¢
            if (app.isLoading) return;
            
            showLoading();
            console.log('PDFä¿å­˜å‡¦ç†é–‹å§‹');
            
            try {
                // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¿å­˜
                saveCurrentPageFields();
                
                // PDFãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
                const fileData = await readFileAsArrayBuffer(app.pdfFile);
                const pdfDoc = await PDFLib.PDFDocument.load(fileData, { ignoreEncryption: true });
                
                // ãƒ•ã‚©ãƒ³ãƒˆã‚’åŸ‹ã‚è¾¼ã‚€
                const helveticaFont = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
                
                // å…¨ãƒšãƒ¼ã‚¸ã‚’å‡¦ç†
                console.log(`å…¨ãƒšãƒ¼ã‚¸å‡¦ç†é–‹å§‹: ${app.totalPages}ãƒšãƒ¼ã‚¸`);
                
                // å„ãƒšãƒ¼ã‚¸ã‚’å‡¦ç†
                for (let pageNumber = 1; pageNumber <= app.totalPages; pageNumber++) {
                    const pageFields = app.fields[pageNumber] || [];
                    if (pageFields.length === 0) {
                        console.log(`ãƒšãƒ¼ã‚¸ ${pageNumber}: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãªã— - ã‚¹ã‚­ãƒƒãƒ—`);
                        continue;
                    }
                    
                    console.log(`ãƒšãƒ¼ã‚¸ ${pageNumber} å‡¦ç†é–‹å§‹: ${pageFields.length}ä»¶ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰`);
                    
                    // PDFã®ãƒšãƒ¼ã‚¸ã‚’å–å¾—
                    const pdfPage = pdfDoc.getPages()[pageNumber - 1];
                    if (!pdfPage) {
                        console.error(`ãƒšãƒ¼ã‚¸ ${pageNumber} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                        continue;
                    }
                    
                    const { width, height } = pdfPage.getSize();
                    
                    console.log(`ãƒšãƒ¼ã‚¸ ${pageNumber} ã‚µã‚¤ã‚º: ${width} x ${height}`);
                    
                    // ã“ã®ãƒšãƒ¼ã‚¸ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‡¦ç†
                    for (const field of pageFields) {
                        const obj = field.object;
                        
                        if (!obj) {
                            console.warn(`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ ${field.id} ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ - ã‚¹ã‚­ãƒƒãƒ—`);
                            continue;
                        }
                        
                        try {
                            // ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã‚’PDFåº§æ¨™ã«å¤‰æ›ï¼ˆãƒšãƒ¼ã‚¸ç•ªå·ã‚’æ˜ç¤ºçš„ã«æŒ‡å®šï¼‰
                            const pdfCoords = app.coordinateSystem.canvasToPdf(
                                obj.left / app.zoomLevel,
                                obj.top / app.zoomLevel,
                                pageNumber
                            );
                            
                            console.log(`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‡¦ç† (ãƒšãƒ¼ã‚¸ ${pageNumber}): ${field.type}, PDFåº§æ¨™: (${pdfCoords.x}, ${pdfCoords.y})`);
                            
                            // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ä½ç½®ãƒ‡ãƒ¼ã‚¿
                            const fieldData = {
                                type: field.type,
                                left: pdfCoords.x,
                                top: pdfCoords.y,
                                text: obj.text,
                                fontSize: obj.fontSize,
                                fontWeight: obj.fontWeight,
                                fontStyle: obj.fontStyle,
                                radius: obj.radius ? obj.radius / app.zoomLevel : undefined,
                                x1: obj.x1 ? obj.x1 / app.zoomLevel : undefined,
                                y1: obj.y1 ? obj.y1 / app.zoomLevel : undefined,
                                x2: obj.x2 ? obj.x2 / app.zoomLevel : undefined,
                                y2: obj.y2 ? obj.y2 / app.zoomLevel : undefined
                            };
                            
                            await processField(fieldData, pdfPage, pdfDoc, pageNumber);
                        } catch (fieldError) {
                            console.error(`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${fieldError.message}`, fieldError);
                        }
                    }
                }
                
                // ä¿å­˜ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                console.log('PDFç”Ÿæˆä¸­...');
                const pdfBytes = await pdfDoc.save();
                const outputFilename = app.pdfFile.name.replace(/\.pdf$/i, '_filled.pdf');
                
                saveAs(new Blob([pdfBytes], { type: 'application/pdf' }), outputFilename);
                
                console.log(`PDFä¿å­˜å®Œäº†: ${outputFilename}`);
                hideLoading();
                
            } catch (error) {
                console.error(`PDFä¿å­˜ã‚¨ãƒ©ãƒ¼:`, error);
                showDetailedError('PDFã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', error);
                hideLoading();
            }
        }
        
        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‡¦ç†
        async function processField(field, pdfPage, pdfDoc, pageNumber) {
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œæˆ
            const tempCanvas = document.createElement('canvas');
            const tempContext = tempCanvas.getContext('2d');
            
            console.log(`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‡¦ç†: ${field.type}, PDFåº§æ¨™: (${field.left}, ${field.top})`);
            
            try {
                // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸå‡¦ç†
                switch (field.type) {
                    case 'text':
                        // ãƒ•ã‚©ãƒ³ãƒˆã®è¨­å®š
                        const fontWeight = field.fontWeight === 'bold' ? 'bold ' : '';
                        const fontStyle = field.fontStyle === 'italic' ? 'italic ' : '';
                        const fontSize = field.fontSize;
                        
                        // ãƒ†ã‚­ã‚¹ãƒˆã®å¹…ã‚’è¨ˆç®—
                        tempContext.font = `${fontWeight}${fontStyle}${fontSize}px sans-serif`;
                        const textWidth = tempContext.measureText(field.text).width;
                        
                        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºè¨­å®š
                        const padding = 2;
                        tempCanvas.width = textWidth + (padding * 2);
                        tempCanvas.height = fontSize * 1.2;
                        
                        // é€æ˜èƒŒæ™¯
                        tempContext.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
                        
                        // ãƒ•ã‚©ãƒ³ãƒˆå†è¨­å®š
                        tempContext.font = `${fontWeight}${fontStyle}${fontSize}px sans-serif`;
                        tempContext.fillStyle = 'black';
                        tempContext.fillText(field.text, padding, fontSize);
                        
                        // ç”»åƒã¨ã—ã¦åŸ‹ã‚è¾¼ã¿
                        const imgData = tempCanvas.toDataURL('image/png');
                        const textImage = await pdfDoc.embedPng(imgData);
                        
                        // PDFåº§æ¨™ã§ã®æç”»ä½ç½®
                        pdfPage.drawImage(textImage, {
                            x: field.left,
                            y: field.top - fontSize, // ãƒ†ã‚­ã‚¹ãƒˆã®ä¸Šç«¯ã«åˆã‚ã›ã‚‹
                            width: tempCanvas.width,
                            height: tempCanvas.height
                        });
                        
                        break;
                    
                    case 'checkbox':
                    case 'x-mark':
                        const symbol = field.type === 'checkbox' ? 'âœ“' : 'âœ—';
                        const size = field.fontSize * 1.2;
                        
                        tempCanvas.width = size;
                        tempCanvas.height = size;
                        
                        tempContext.clearRect(0, 0, size, size);
                        tempContext.font = `${field.fontSize}px sans-serif`;
                        tempContext.fillStyle = 'black';
                        tempContext.textAlign = 'center';
                        tempContext.textBaseline = 'middle';
                        tempContext.fillText(symbol, size/2, size/2);
                        
                        const markImgData = tempCanvas.toDataURL('image/png');
                        const markImage = await pdfDoc.embedPng(markImgData);
                        
                        pdfPage.drawImage(markImage, {
                            x: field.left - (size / 2),
                            y: field.top - size,
                            width: size,
                            height: size
                        });
                        
                        break;
                    
                    case 'dot':
                        const dotSize = field.radius * 2.5;
                        
                        tempCanvas.width = dotSize;
                        tempCanvas.height = dotSize;
                        
                        tempContext.clearRect(0, 0, dotSize, dotSize);
                        tempContext.beginPath();
                        tempContext.arc(dotSize/2, dotSize/2, field.radius, 0, Math.PI * 2);
                        tempContext.fillStyle = 'black';
                        tempContext.fill();
                        
                        const dotImgData = tempCanvas.toDataURL('image/png');
                        const dotImage = await pdfDoc.embedPng(dotImgData);
                        
                        pdfPage.drawImage(dotImage, {
                            x: field.left - (dotSize / 2),
                            y: field.top - dotSize,
                            width: dotSize,
                            height: dotSize
                        });
                        
                        break;
                    
                    case 'circle':
                        const circleSize = field.radius * 2.5;
                        
                        tempCanvas.width = circleSize;
                        tempCanvas.height = circleSize;
                        
                        tempContext.clearRect(0, 0, circleSize, circleSize);
                        tempContext.beginPath();
                        tempContext.arc(circleSize/2, circleSize/2, field.radius, 0, Math.PI * 2);
                        tempContext.strokeStyle = 'black';
                        tempContext.lineWidth = 2;
                        tempContext.stroke();
                        
                        const circleImgData = tempCanvas.toDataURL('image/png');
                        const circleImage = await pdfDoc.embedPng(circleImgData);
                        
                        pdfPage.drawImage(circleImage, {
                            x: field.left - (circleSize / 2),
                            y: field.top - circleSize,
                            width: circleSize,
                            height: circleSize
                        });
                        
                        break;
                    
                    case 'strikethrough':
                        const lineWidth = 50;
                        const lineHeight = 10;
                        
                        tempCanvas.width = lineWidth;
                        tempCanvas.height = lineHeight;
                        
                        tempContext.clearRect(0, 0, lineWidth, lineHeight);
                        tempContext.beginPath();
                        tempContext.moveTo(5, lineHeight/2);
                        tempContext.lineTo(lineWidth - 5, lineHeight/2);
                        tempContext.strokeStyle = 'black';
                        tempContext.lineWidth = 2;
                        tempContext.stroke();
                        
                        const lineImgData = tempCanvas.toDataURL('image/png');
                        const lineImage = await pdfDoc.embedPng(lineImgData);
                        
                        pdfPage.drawImage(lineImage, {
                            x: field.left,
                            y: field.top - (lineHeight / 2),
                            width: lineWidth,
                            height: lineHeight
                        });
                        
                        break;
                }
            } catch (error) {
                throw new Error(`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‡¦ç†ä¸­ã®ã‚¨ãƒ©ãƒ¼ (${field.type}): ${error.message}`);
            } finally {
                // ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢
                tempCanvas.width = 0;
                tempCanvas.height = 0;
            }
        }
        
        // ç·¨é›†ãƒ‡ãƒ¼ã‚¿ã®JSONå½¢å¼ä¿å­˜æ©Ÿèƒ½
        function saveEditData() {
            if (!app.pdfFile) {
                showError('PDFãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }
            
            // é‡è¤‡å‡¦ç†é˜²æ­¢
            if (app.isLoading) return;
            
            try {
                // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¿å­˜
                saveCurrentPageFields();
                
                // ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
                const editData = {
                    pdfName: app.pdfFile.name,
                    totalPages: app.totalPages,
                    pageSizes: app.pageSizes,
                    fields: {}
                };
                
                // å„ãƒšãƒ¼ã‚¸ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æƒ…å ±ã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º
                for (const pageNumber in app.fields) {
                    const pageFields = app.fields[pageNumber];
                    if (!pageFields || pageFields.length === 0) continue;
                    
                    // ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºå¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ä¿å­˜
                    editData.fields[pageNumber] = pageFields.map(field => {
                        const obj = field.object;
                        if (!obj) return null;
                        
                        // åŸºæœ¬æƒ…å ±ã®ã¿ã‚’ä¿å­˜ï¼ˆå¾ªç’°å‚ç…§ã‚’é¿ã‘ã‚‹ï¼‰
                        const serializedField = {
                            id: field.id,
                            type: field.type,
                            left: obj.left,
                            top: obj.top
                        };
                        
                        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸè¿½åŠ æƒ…å ±
                        switch (field.type) {
                            case 'text':
                                serializedField.text = obj.text;
                                serializedField.fontSize = obj.fontSize;
                                serializedField.fontWeight = obj.fontWeight;
                                serializedField.fontStyle = obj.fontStyle;
                                serializedField.fontFamily = obj.fontFamily;
                                serializedField.fill = obj.fill;
                                break;
                                
                            case 'checkbox':
                            case 'x-mark':
                                serializedField.fontSize = obj.fontSize;
                                serializedField.fontFamily = obj.fontFamily;
                                serializedField.fill = obj.fill;
                                break;
                                
                            case 'dot':
                            case 'circle':
                                serializedField.radius = obj.radius;
                                serializedField.fill = obj.fill;
                                if (field.type === 'circle') {
                                    serializedField.stroke = obj.stroke;
                                    serializedField.strokeWidth = obj.strokeWidth;
                                }
                                break;
                                
                            case 'strikethrough':
                                serializedField.x1 = obj.x1;
                                serializedField.y1 = obj.y1;
                                serializedField.x2 = obj.x2;
                                serializedField.y2 = obj.y2;
                                serializedField.stroke = obj.stroke;
                                serializedField.strokeWidth = obj.strokeWidth;
                                break;
                        }
                        
                        return serializedField;
                    }).filter(Boolean); // nullã‚¨ãƒ³ãƒˆãƒªã‚’å‰Šé™¤
                }
                
                // JSONã«å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const jsonData = JSON.stringify(editData, null, 2);
                const filename = app.pdfFile.name.replace(/\.pdf$/i, '_editdata.json');
                const blob = new Blob([jsonData], { type: 'application/json' });
                saveAs(blob, filename);
                
                console.log(`ç·¨é›†ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜: ${filename}`);
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showDetailedError('ç·¨é›†ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
            }
        }
        
        // JSONå½¢å¼ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿æ©Ÿèƒ½
        function loadEditData() {
            if (!app.pdfFile) {
                showError('å…ˆã«PDFã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // é‡è¤‡å‡¦ç†é˜²æ­¢
            if (app.isLoading) return;
            
            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            
            input.onchange = async (e) => {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    
                    try {
                        showLoading();
                        
                        // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            try {
                                // JSONãƒ‡ãƒ¼ã‚¿ã‚’è§£æ
                                const editData = JSON.parse(event.target.result);
                                
                                // PDFãƒ•ã‚¡ã‚¤ãƒ«åãƒã‚§ãƒƒã‚¯
                                if (editData.pdfName !== app.pdfFile.name) {
                                    const confirmed = confirm(
                                        `ç·¨é›†ãƒ‡ãƒ¼ã‚¿ã¯ã€Œ${editData.pdfName}ã€ç”¨ã§ã™ãŒã€ç¾åœ¨èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹PDFã¯ã€Œ${app.pdfFile.name}ã€ã§ã™ã€‚\n` +
                                        `ãã‚Œã§ã‚‚èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ`
                                    );
                                    
                                    if (!confirmed) {
                                        hideLoading();
                                        return;
                                    }
                                }
                                
                                // ç·¨é›†ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨
                                await applyEditData(editData);
                                
                                hideLoading();
                            } catch (error) {
                                console.error('JSONãƒ‡ãƒ¼ã‚¿ã®è§£æã‚¨ãƒ©ãƒ¼:', error);
                                showDetailedError('ç·¨é›†ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                                hideLoading();
                            }
                        };
                        
                        reader.onerror = (e) => {
                            console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
                            showDetailedError('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', e.target.error);
                            hideLoading();
                        };
                        
                        reader.readAsText(file);
                        
                    } catch (error) {
                        console.error('ç·¨é›†ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                        showDetailedError('ç·¨é›†ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                        hideLoading();
                    }
                }
            };
            
            input.click();
        }
        
        // ç·¨é›†ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨ã™ã‚‹é–¢æ•°
        async function applyEditData(editData) {
            console.log('ç·¨é›†ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨ä¸­...');
            
            try {
                // ç¾åœ¨ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
                app.fields = {};
                
                // ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºæƒ…å ±ã®å¾©å…ƒ
                if (editData.pageSizes) {
                    app.pageSizes = editData.pageSizes;
                }
                
                // å„ãƒšãƒ¼ã‚¸ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨
                for (const pageNumber in editData.fields) {
                    const pageFields = editData.fields[pageNumber];
                    if (!pageFields || pageFields.length === 0) continue;
                    
                    const parsedPageNumber = parseInt(pageNumber, 10);
                    
                    // ãƒšãƒ¼ã‚¸ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰é…åˆ—ã‚’åˆæœŸåŒ–
                    app.fields[parsedPageNumber] = [];
                    
                    // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‡¦ç†
                    for (const fieldData of pageFields) {
                        // æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
                        const field = {
                            id: fieldData.id || `field-${Date.now()}-${Math.floor(Math.random() * 1000)}`,
                            type: fieldData.type,
                            data: fieldData // Fabric.jsã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                        };
                        
                        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
                        app.fields[parsedPageNumber].push(field);
                    }
                    
                    console.log(`ãƒšãƒ¼ã‚¸ ${pageNumber} ã« ${pageFields.length} ä»¶ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒ­ãƒ¼ãƒ‰`);
                }
                
                // ç¾åœ¨è¡¨ç¤ºä¸­ã®ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿
                if (app.currentPage > app.totalPages) {
                    app.currentPage = 1;
                }
                
                await loadPage(app.currentPage);
                
                console.log('ç·¨é›†ãƒ‡ãƒ¼ã‚¿ã®é©ç”¨å®Œäº†');
            } catch (error) {
                console.error('ç·¨é›†ãƒ‡ãƒ¼ã‚¿é©ç”¨ã‚¨ãƒ©ãƒ¼:', error);
                throw error; // å‘¼ã³å‡ºã—å…ƒã§ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã™ã‚‹ãŸã‚ã«ã‚¹ãƒ­ãƒ¼
            }
        }
    </script>
</body>
</html>